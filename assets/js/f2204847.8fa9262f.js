"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2134],{6845:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var o=n(8168),a=(n(6540),n(5680));const r={id:"lz-composition",sidebar_position:3},i="Code-less composition across state files",l={unversionedId:"fundamentals/lz-composition",id:"fundamentals/lz-composition",title:"Code-less composition across state files",description:"To deliver an enterprise environment, it is usually reasonable to do so across multiple state files to balance the risk, manage different lifecycle and teams. Just as for any other software project, we want to avoid a monolithic configuration and instead compose an environment calling multiple landing zones.",source:"@site/docs/fundamentals/composition.md",sourceDirName:"fundamentals",slug:"/fundamentals/lz-composition",permalink:"/documentation/docs/next/fundamentals/lz-composition",draft:!1,editUrl:"https://github.com/aztfmod/documentation/tree/main/website/docs/fundamentals/composition.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"lz-composition",sidebar_position:3},sidebar:"cafSidebar",previous:{title:"Compute Nodes",permalink:"/documentation/docs/next/fundamentals/lz-compute"},next:{title:"Introduction to the CAF super-module",permalink:"/documentation/docs/next/module/module-intro"}},s={},c=[{value:"Composition outside of the CAF object model",id:"composition-outside-of-the-caf-object-model",level:3},{value:"Example with name",id:"example-with-name",level:4},{value:"Example with resource ID",id:"example-with-resource-id",level:4},{value:"Global settings",id:"global-settings",level:3}],u={toc:c},p="wrapper";function m(e){let{components:t,...n}=e;return(0,a.yg)(p,(0,o.A)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.yg)("h1",{id:"code-less-composition-across-state-files"},"Code-less composition across state files"),(0,a.yg)("p",null,"To deliver an enterprise environment, it is usually reasonable to do so across multiple state files to balance the risk, manage different lifecycle and teams. Just as for any other software project, we want to avoid a monolithic configuration and instead compose an environment calling multiple landing zones."),(0,a.yg)("p",null,"With Terraform, you can read a state file's output and use it as input variables for another landing zone."),(0,a.yg)("p",null,"We use this feature to compose complex architectures, but we do it automatically for you not having to write any line of code."),(0,a.yg)("p",null,"Reading another landing zone content is implemented by a variable, vastly simplifying for you the composition and the complex configuration creation."),(0,a.yg)("p",null,"How to compose from one landing zones to another?"),(0,a.yg)("p",null,"Each landing zones is defined by a ",(0,a.yg)("inlineCode",{parentName:"p"},"configuration.tfvars")," or ",(0,a.yg)("inlineCode",{parentName:"p"},"landingzones.tfvars"),"."),(0,a.yg)("p",null,"As an example below, this is the file for management landing zone in level 1:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-hcl"},'landingzone = {\n  backend_type        = "azurerm"\n  level               = "level1"\n  key                 = "management"\n  global_settings_key = "launchpad"\n  tfstates = {\n    launchpad = {\n      tfstate   = "caf_launchpad.tfstate"\n      workspace = "tfstate"\n      level     = "lower"\n    }\n  }\n}\n')),(0,a.yg)("p",null,"In the ",(0,a.yg)("inlineCode",{parentName:"p"},"tfstate")," section, you can observe an object called ",(0,a.yg)("inlineCode",{parentName:"p"},"launchpad"),", which mentions to Terraform to load under that name, the Terraform state file ",(0,a.yg)("inlineCode",{parentName:"p"},"caf_launchpad.tfstate"),". That state file is stored inside the workspace (storage container) ",(0,a.yg)("inlineCode",{parentName:"p"},"tfstate")," located one level lower (since current level is level1 - mentioned in the field level), then we refer to level 0."),(0,a.yg)("p",null,"What it means that for any object inside that particular landing zones, you can refer to any object wheter it has been deployed in the same deployment or in another deployment (within the same level or one level below)."),(0,a.yg)("p",null,"For instance in your level1 - management deployment, you can deploy a resources within a resource group that has been provisioned in the level below:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-hcl"},'automations = {\n  account1 = {\n    name = "automationAccount1"\n    sku  = "Basic"\n    resource_group = {\n      key    = "auto-account"\n      lz_key = "launchpad"\n    }\n  }\n}\n')),(0,a.yg)("p",null,"The same concept applies throughout the components of the framework and allow you to compose virtually across any object of the model. That composition model allows you to compose with the objects without caring of the real name of the object (real name of the resource, after the naming convention applies)"),(0,a.yg)("h3",{id:"composition-outside-of-the-caf-object-model"},"Composition outside of the CAF object model"),(0,a.yg)("p",null,"Sometimes you have to deal with objects deployed manually, via another automation. You are then able to compose with those objects referring to their resource ID or sometimes names:"),(0,a.yg)("h4",{id:"example-with-name"},"Example with name"),(0,a.yg)("p",null,"In this case you simply refer to the resource group name as it exists already in the target subscription for the deployment:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-hcl"},'automations = {\n  account1 = {\n    name = "automationAccount1"\n    sku  = "Basic"\n    resource_group = {\n      name    = "caf-auto-account-zooz-001"\n    }\n  }\n}\n')),(0,a.yg)("h4",{id:"example-with-resource-id"},"Example with resource ID"),(0,a.yg)("p",null,"In this case you simply refer to the resource group's resource ID as it exists already in the target subscription for the deployment:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-hcl"},'virtual_hub_connections = {\n  vnet_to_hub = {\n    name = "vnet-connectivity-prod-fw-plinks-TO-vhub-prod"\n    virtual_hub = {\n      lz_key = "connectivity_virtual_hubs_prod"\n      key    = "prod"\n    }\n    vnet = {\n      resource_id = "/subscriptions/dklsdfk/etc."\n    }\n  }\n}\n')),(0,a.yg)("h3",{id:"global-settings"},"Global settings"),(0,a.yg)("p",null,"A few exceptions exist to the hierarchy model, there are variables and value that are persisted across all levels and reachable from all levels:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("strong",{parentName:"li"},"global settings"),": everything related to the commons for a particular environment (which regions are supported for an environment, which naming convention is used, the tags inheritance settings, etc.)"),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("strong",{parentName:"li"},"diagnostics settings"),": any diagnostics repository you create at any level will be stored and will become composable from the current and above levels.")))}m.isMDXComponent=!0},5680:(e,t,n)=>{n.d(t,{xA:()=>u,yg:()=>f});var o=n(6540);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=c(n),d=a,f=p["".concat(s,".").concat(d)]||p[d]||m[d]||r;return n?o.createElement(f,i(i({ref:t},u),{},{components:n})):o.createElement(f,i({ref:t},u))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[p]="string"==typeof e?e:a,i[1]=l;for(var c=2;c<r;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);